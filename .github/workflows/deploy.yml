name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Debug SSH
        run: |
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ –∫–ª—é—á–∏ –≤ –∞–≥–µ–Ω—Ç–µ
          ssh-add -l

          # –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ VPS —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–æ–º
          ssh -vvv -o StrictHostKeyChecking=no \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
              echo "SSH connection OK"

      - name: Copy files to VPS
        run: |
          scp -vvv \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -r ./ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}

      - name: Run deployment commands
        run: |
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.VPS_PATH }}

            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Composer –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            docker run --rm \
              -v $PWD:/app \
              -w /app \
              composer install --no-interaction --prefer-dist --optimize-autoloader

              chmod -R 777 storage bootstrap/cache node-services

            # –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker-compose down
            ./vendor/bin/sail build --no-cache
            ./vendor/bin/sail up -d



            # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
            echo "üîÑ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π..."
            ./vendor/bin/sail artisan migrate --force

            # –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NPM –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            ./vendor/bin/sail npm install
            ./vendor/bin/sail npm run prod

            # Node‚Äëservices
            if [ -d "node-services" ]; then
              echo "üì¶ Node‚Äëservices deps..."
              cd node-services
              ../vendor/bin/sail npm install
              cd ..
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "üîÑ –†–µ—Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤..."
            ./vendor/bin/sail down
            ./vendor/bin/sail up -d

            echo "üöÄ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          EOF
